<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/lib/echarts.min.js"></script>
    <script src="/lib/jquery-3.6.0.js"></script>
    <script src="/lib/adcode_info.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        input {
            width: 70px;
        }

        .hidden-h2 {
            display: none;
        }
    </style>
</head>

<body style="width: 1700px;">
    <div
        style="position: fixed;z-index:99; border: 1px solid black;width: 100%;height: 25px;padding: 5px;background-color: black">

        <input id="input_adcode" type="number" value="100000">
        <input id="hope_year" type="number" value="2013">
        <button onclick="javascript:day_control(-1,0,0)">上一年</button>
        <button onclick="javascript:day_control(1,0,0)">下一年</button>
        <input id="hope_month" type="number" value="1">
        <button onclick="javascript:day_control(0,-1,0)">上一月</button>
        <button onclick="javascript:day_control(0,1,0)">下一月</button>
        <input id="hope_day" type="number" value="1">
        <button onclick="javascript:day_control(0,0,-1)">上一天</button>
        <button onclick="javascript:day_control(0,0,1)">下一天</button>
        <button onclick="javascript:input_refresh()">按照输入的数据刷新地图</button>
    </div>
    <div style="position: absolute; width: 1600px; height: 750px; margin-top: 50px;">
        <div style="float: left; width: 800px; height: 100px;">
            <h2 class="hidden-h2"><span id="current_project_name"></span><span
                    id="current_day"></span></h2>
            <div id="map_chart01" style="width: 100%; height: 100%"></div>
        </div>
        <div style="margin-left: -140px;float: left; width: 600px; height: 550px; margin-top: 0;">
            <div id="wind_echart_01" style="width: 100%; height: 100%"></div>
        </div>
    </div>

    <script>
        let theme_name = 'vintage'

        var MyMapCharts = echarts.init(document.querySelector('#map_chart01'), theme_name)

        window.onload = function () {
            document.getElementById("current_project_name").innerText = current_project_name
            refresh_by_adcode_and_date_and_item(100000, 2013, 1, 1, current_project_name)
            setTimeout(input_refresh, 3000)
            MyMapCharts.on("click", async (args) => {
                const adcode = args.data.adcode
                document.querySelector("#input_adcode").value = adcode
                input_refresh()
            })

            MyMapCharts.getZr().on("dblclick", async (args) => {
                if (args.target == undefined) {
                    const adcode = document.querySelector("#input_adcode").value
                    if (adcode_info[adcode].parent !== null) {
                        document.querySelector("#input_adcode").value = adcode_info[adcode].parent
                        input_refresh()
                    }
                }
            })
        }

        function day_control(y, m, d) {
            let year = parseInt(document.querySelector("#hope_year").value) + y
            let month = parseInt(document.querySelector("#hope_month").value) + m
            let day = parseInt(document.querySelector("#hope_day").value) + d
            if (([1, 3, 5, 7, 8, 10, 12].indexOf(month) != -1 && day >= 32)
                || ([4, 6, 9, 11].indexOf(month) != -1 && day >= 31)
                || ([2].indexOf(month) != -1 && year % 4 != 0 && day >= 29)
                || ([2].indexOf(month) != -1 && year % 4 == 0 && day >= 30)) {
                month++
                day = 1
            }
            if (month == 13) {
                month = 1
                year++
            }
            if (month == 0) {
                month = 12
                year--
            }
            document.querySelector("#hope_year").value = year
            document.querySelector("#hope_month").value = month
            document.querySelector("#hope_day").value = day

            input_refresh()
        }


        function input_refresh() {
            const input_adcode = document.querySelector("#input_adcode").value
            let year = document.querySelector("#hope_year").value
            let month = document.querySelector("#hope_month").value
            let day = document.querySelector("#hope_day").value
            document.querySelector("#current_day").innerText = ' ' + year + '-' + ('0' + month).slice(-2) + '-' + ('0' + day).slice(-2)
            refresh_by_adcode_and_date_and_item(input_adcode, year, month, day, current_project_name)
            get_wind_echart_show(year, month, day)

        }


        function refresh_by_adcode_and_date_and_item(adcode, year, month, day, air_item_name) {
            let geo_json_path
            if (adcode_info[adcode].childrenNum > 0) {
                geo_json_path = "/data/100000_full.json"
            } else {
                geo_json_path = "/data/100000.json"
            }
            month = ("0" + month).slice(-2)
            day = ("0" + day).slice(-2)
            const data_json_path = "/data/wind_20130101.json"
            refresh(geo_json_path, data_json_path, air_item_name)
        }


        function refresh(geo_json_path, data_json_path, air_item_name) {
            $.when($.getJSON(geo_json_path), $.getJSON(data_json_path)).then(function (ret, pmvalue) {
                let map_adcode = geo_json_path.slice(6, 12)
                let max_should_be = 300
                if (air_item_name == 'PM10') {
                    max_should_be = 350
                } else if (air_item_name == 'PM2.5') {
                    max_should_be = 150
                } else if (air_item_name == 'SO2') {
                    max_should_be = 800
                } else if (air_item_name == 'NO2') {
                    max_should_be = 280
                } else if (air_item_name == 'O3') {
                    max_should_be = 400
                } else if (air_item_name == 'CO') {
                    max_should_be = 24
                } else if (air_item_name == 'AQI') {
                    max_should_be = 200
                }
                ret = ret[0]
                pmvalue = pmvalue[0]
                let maxmax = 0
                echarts.registerMap(map_adcode, ret)
                var airData = ret.features.map((k) => {
                    if (k.properties.name == "")
                        return { name: k.properties.name, value: 0 }
                    let v = pmvalue[k.properties.adcode][air_item_name] ? pmvalue[k.properties.adcode][air_item_name] : 0
                    if (maxmax < v) {
                        maxmax = v
                    }
                    return { name: k.properties.name, value: v, adcode: k.properties.adcode }
                })

                geo_center = adcode_info[parseInt(geo_json_path.slice(6, 12))].centroid


            })
        }
    </script>
    <script src="../js/CountryWind.js"></script>
</body>

</html>